\ProvidesPackage{secbacklinktoc}
  [2024/07/07 v1.1 Add section backlinks to TOC]

\RequirePackage{hyperref}
\newcommand{\middlemark}{}

% =========================================================================
% Appendix Commands (App Chapter/Section/Subsection/Subsubsection)
% =========================================================================

\let\hyperappchapter\chapter
\def\appchapter{\@ifstar\starappchapter\myappchapter}
\def\starappchapter{\hyperappchapter*}
\newcommand{\myappchapter}[2][\@empty]%
{%
    % 1. 执行命令（更新计数器）
	\ifx#1\@empty
        \hyperappchapter[\protect\hyperlink{toc.appendix.\appthechapter}{#2}]{\hyperlink{toc.appendix.\appthechapter}{#2}}%
	\else
        \hyperappchapter[#1]{\hyperlink{toc.appendix.\appthechapter}{#2}}%
	\fi
    % 2. 更新标记（此时 \appthechapter 已是最新）
    \renewcommand{\middlemark}{\appthechapter~~~~\hyperlink{toc.appendix.\appthechapter}{#2}}%
}

\let\hyperappsection\section
\def\appsection{\@ifstar\starappsection\myappsection}
\def\starappsection{\hyperappsection*}
\newcommand{\myappsection}[2][\@empty]%
{%
	\ifx#1\@empty
        \hyperappsection[\protect\hyperlink{toc.section.\appthesection}{#2}]{\hyperlink{toc.section.\appthesection}{#2}}%
	\else
        \hyperappsection[#1]{\hyperlink{toc.section.\appthesection}{#2}}%
	\fi
    \renewcommand{\middlemark}{\appthesection~~~~\hyperlink{toc.section.\appthesection}{#2}}%
}

\let\hyperappsubsection\subsection
\def\appsubsection{\@ifstar\starappsubsection\myappsubsection}
\def\starappsubsection{\hyperappsubsection*}
\newcommand{\myappsubsection}[2][\@empty]%
{%
	\ifx#1\@empty
        \hyperappsubsection[\protect\hyperlink{toc.subsection.\appthesubsection}{#2}]{\hyperlink{toc.subsection.\appthesubsection}{#2}}%
	\else
        \hyperappsubsection[#1]{\hyperlink{toc.subsection.\appthesubsection}{#2}}%
	\fi
    \renewcommand{\middlemark}{\appthesubsection~~~~\hyperlink{toc.subsection.\appthesubsection}{#2}}%
}

\let\hyperappsubsubsection\subsubsection
\def\appsubsubsection{\@ifstar\starappsubsubsection\myappsubsubsection}
\def\starappsubsubsection{\hyperappsubsubsection*}
\newcommand{\myappsubsubsection}[2][\@empty]%
{%
 	\ifx#1\@empty
        \hyperappsubsubsection[\protect\hyperlink{toc.subsubsection.\appthesubsubsection}{#2}]{\hyperlink{toc.subsubsection.\appthesubsubsection}{#2}}%
	\else
        \hyperappsubsubsection[#1]{\hyperlink{toc.subsubsection.\appthesubsubsection}{#2}}%
	\fi
    \renewcommand{\middlemark}{\appthesubsubsection~~~~\hyperlink{toc.subsubsection.\appthesubsubsection}{#2}}%
}

% =========================================================================
% Standard Commands (Chapter/Section/Subsection/Subsubsection)
% =========================================================================

\let\hyperchapter\chapter
\def\chapter{\@ifstar\starchapter\mychapter}
\def\starchapter{\hyperchapter*}
\newcommand{\mychapter}[2][\@empty]%
{%
    % 1. 执行命令
	\ifx#1\@empty
        \hyperchapter[\protect\hyperlink{toc.chapter.\thechapter}{#2}]{\hyperlink{toc.chapter.\thechapter}{#2}}%
	\else
        \hyperchapter[#1]{\hyperlink{toc.chapter.\thechapter}{#2}}%
	\fi
    % 2. 更新标记
    \renewcommand{\middlemark}{\thechapter~~~~\hyperlink{toc.chapter.\thechapter}{#2}}%
}

\let\hypersection\section
\def\section{\@ifstar\starsection\mysection}
\def\starsection{\hypersection*}
\newcommand{\mysection}[2][\@empty]%
{%
	\ifx#1\@empty
        \hypersection[\protect\hyperlink{toc.section.\thesection}{#2}]{\hyperlink{toc.section.\thesection}{#2}}%
	\else
        \hypersection[#1]{\hyperlink{toc.section.\thesection}{#2}}%
	\fi
    \renewcommand{\middlemark}{\thesection~~~~\hyperlink{toc.section.\thesection}{#2}}%
}

\let\hypersubsection\subsection
\def\subsection{\@ifstar\starsubsection\mysubsection}
\def\starsubsection{\hypersubsection*}
\newcommand{\mysubsection}[2][\@empty]%
{%
	\ifx#1\@empty
        \hypersubsection[\protect\hyperlink{toc.subsection.\thesubsection}{#2}]{\hyperlink{toc.subsection.\thesubsection}{#2}}%
	\else
        \hypersubsection[#1]{\hyperlink{toc.subsection.\thesubsection}{#2}}%
	\fi
    \renewcommand{\middlemark}{\thesubsection~~~~\hyperlink{toc.subsection.\thesubsection}{#2}}%
}

\let\hypersubsubsection\subsubsection
\def\subsubsection{\@ifstar\starsubsubsection\mysubsubsection}
\def\starsubsubsection{\hypersubsubsection*}
\newcommand{\mysubsubsection}[2][\@empty]%
{%
	\ifx#1\@empty
	    \hypersubsubsection[\protect\hyperlink{toc.subsubsection.\thesubsubsection}{#2}]{\hyperlink{toc.subsubsection.\thesubsubsection}{#2}}%
	\else
	    \hypersubsubsection[#1]{\hyperlink{toc.subsubsection.\thesubsubsection}{#2}}%
	\fi
	\renewcommand{\middlemark}{\thesubsubsection~~~~\hyperlink{toc.subsubsection.\thesubsubsection}{#2}}%
}

% =========================================================================
% TOC Linking Logic
% =========================================================================

% Set backlink target in TOC
\let\hypercontentsline=\contentsline
\renewcommand{\contentsline}[4]{\hypertarget{toc.#4}{}\hypercontentsline{#1}{#2}{#3}{#4}}

% For clickable numbers in section headers (redefining internal logic)
\def\@sect#1#2#3#4#5#6[#7]#8{%
	\ifnum #2>\c@secnumdepth
	  \let\@svsec\@empty
	\else
	  \refstepcounter{#1}%
	  \protected@edef\@svsec{\@seccntformat{#1}\relax}%
	\fi
	\@tempskipa #5\relax
	\ifdim \@tempskipa>\z@
	  \begingroup
	    #6{\sbox0{\@svsec}% measure width
		\interlinepenalty \@M
		\hangindent=\dimexpr \wd0+#3\relax
		\noindent\hskip #3\relax
        % Modified: Add Link to the Number
		\hyperlink{toc.#1.\csname the#1\endcsname}%
		{\@svsec #8}%
		\@@par}%
	  \endgroup
	  \csname #1mark\endcsname{#7}%
	  \addcontentsline{toc}{#1}{%
		\ifnum #2>\c@secnumdepth \else
		  \protect\numberline{\csname the#1\endcsname}%
		\fi
		#7}%
	\else
	  \def\@svsechd{%
		#6{\hskip #3\relax
			\@svsec #8}%
		\csname #1mark\endcsname{#7}%
		\addcontentsline{toc}{#1}{%
			\ifnum #2>\c@secnumdepth \else
			  \protect\numberline{\csname the#1\endcsname}%
			\fi
			#7}}%
	\fi
	\@xsect{#5}}
